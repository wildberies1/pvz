<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wildberries ‚Äî –ü–í–ó</title>
  <!-- 
    –§–∞–π–ª: pvz/index.html
    –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–∞–π—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ü–í–ó
    –ê–≤—Ç–æ—Ä: –°–∏—Å—Ç–µ–º–∞ Wildberries Clone
    –í–µ—Ä—Å–∏—è: 2.0
    –î–∞—Ç–∞: 2025-04-05
    –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
      - –í—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é 0506
      - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–∞
      - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–¥–∞—á–µ–π –∏ –±—Ä–∞–∫–æ–º
      - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ
      - –ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
      - –†–∞–±–æ—Ç–∞ —Å Firebase Realtime Database
      - –ú–∏–Ω–∏–º—É–º 560 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
  -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    /* 
      –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ü–í–ó
      –§–æ–Ω: —Å–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
      –ê–∫—Ü–µ–Ω—Ç—ã: —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #f0f0ff 0%, #e0e0ff 100%); color: #333; min-height: 100vh; }
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
    #login-screen { display: flex; background: linear-gradient(135deg, #6c5ce7 0%, #5d4de0 100%); color: white; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
    .logo { font-size: 36px; font-weight: bold; margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input, button { padding: 14px; margin: 10px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; width: 100%; max-width: 400px; }
    input { background: white; color: #333; }
    button { cursor: pointer; background: #6c5ce7; color: white; border: none; font-weight: bold; }
    button:hover { background: #5d4de0; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-danger { background: #e74c3c; }
    .btn-success { background: #2ecc71; }
    .order-card { background: white; border-radius: 12px; padding: 18px; margin: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
    .header h2 { color: #6c5ce7; }
    .scan-area { background: white; padding: 25px; border-radius: 12px; text-align: center; margin: 20px 0; box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .scan-input { width: 100%; padding: 14px; font-size: 18px; text-align: center; border: 2px solid #6c5ce7; border-radius: 8px; }
    .order-info { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .actions { margin: 20px 0; }
    .status-ready { color: #2ecc71; font-weight: bold; }
    .status-defect { color: #e74c3c; font-weight: bold; }
    .footer { text-align: center; margin-top: auto; padding: 20px; color: #666; font-size: 14px; }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="login-screen" class="screen">
  <div class="logo">–ü–í–ó Wildberries</div>
  <h2>–í—Ö–æ–¥ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>
  <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∫–∞—Å—Å–∏—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ</p>
  <input type="password" id="password-input" placeholder="–ü–∞—Ä–æ–ª—å: 0506" maxlength="4" autofocus />
  <button onclick="login()">–í–æ–π—Ç–∏</button>
  <div class="footer">
    <p>¬© 2025 Wildberries Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="main-screen" class="screen">
  <div class="header">
    <h2>üì¶ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ ‚Äî –ë–∞–ª–∞—à–∏—Ö–∞</h2>
    <button onclick="logout()">–í—ã—Ö–æ–¥</button>
  </div>
  <div class="scan-area">
    <h3>üîç –ù–∞—á–Ω–∏—Ç–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h3>
    <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ –∏–ª–∏ –±—Ä–∞–∫–∞</p>
    <input type="text" class="scan-input" id="scan-input" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥..." oninput="handleScan()" autocomplete="off" />
  </div>
  <div id="order-info" class="order-info" style="display:none;"></div>
  <div class="actions" id="action-buttons" style="display:none;">
    <button class="btn-success" onclick="confirmIssue()">–í—ã–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
    <button class="btn-danger" onclick="markAsDefect()">–ë—Ä–∞–∫</button>
  </div>
  <div class="footer">
    <p>¬© 2025 Wildberries Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<script>
  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
  const CASHIER_PASSWORD = "0506";
  let currentOrderKey = null;

  // === –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ ===
  function login() {
    if (document.getElementById("password-input").value === CASHIER_PASSWORD) {
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("main-screen").style.display = "flex";
      document.getElementById("scan-input").focus();
      logAction("LOGIN", { role: "cashier" });
    } else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    }
  }

  // === –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã ===
  function logout() {
    currentOrderKey = null;
    document.getElementById("main-screen").style.display = "none";
    document.getElementById("login-screen").style.display = "flex";
    document.getElementById("password-input").value = "";
    resetUI();
    logAction("LOGOUT", {});
  }

  // === –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ===
  function resetUI() {
    document.getElementById("order-info").style.display = "none";
    document.getElementById("action-buttons").style.display = "none";
    document.getElementById("scan-input").value = "";
  }

  // === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ===
  function handleScan() {
    const input = document.getElementById("scan-input");
    let value = input.value.trim();

    // –ñ–¥—ë–º –ø–æ–ª–Ω—ã–π –≤–≤–æ–¥ (–æ–±—ã—á–Ω–æ —Å–∫–∞–Ω–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Enter, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –¥–ª–∏–Ω—É)
    if (value.length < 10) return;

    try {
      // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON (QR –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)
      const data = JSON.parse(value);
      if (data.orderId && data.userId) {
        loadOrder(data.orderId);
        input.value = "";
        return;
      }
    } catch (e) {
      // –ï—Å–ª–∏ –Ω–µ JSON ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ID –∑–∞–∫–∞–∑–∞ (–Ω–∞ —Å–ª—É—á–∞–π —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
      if (/^[A-Za-z0-9_-]{20,}$/.test(value)) {
        loadOrder(value);
        input.value = "";
        return;
      }
    }

    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ ‚Äî —Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ 100 –º—Å
    setTimeout(() => {
      if (input.value === value) {
        input.value = "";
      }
    }, 100);
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–∞ ===
  function loadOrder(orderId) {
    showLoading("–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞...");
    
    db.ref('orders/' + orderId).once('value').then(snapshot => {
      const order = snapshot.val();
      if (!order) {
        alert("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
        resetUI();
        return;
      }

      if (order.status !== 'received') {
        alert("‚ö†Ô∏è –ó–∞–∫–∞–∑ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ!");
        resetUI();
        return;
      }

      currentOrderKey = orderId;
      const info = document.getElementById("order-info");
      info.innerHTML = `
        <h3>–ó–∞–∫–∞–∑ ‚Ññ${orderId.slice(-6)}</h3>
        <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.userId}</p>
        <p><strong>–¢–æ–≤–∞—Ä:</strong> ${order.items[0].name}</p>
        <p><strong>–°—É–º–º–∞:</strong> ${order.total} ‚ÇΩ</p>
        <p><strong>–û–ø–ª–∞—Ç–∞:</strong> ${order.paymentMethod === 'cash' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–û–Ω–ª–∞–π–Ω'}</p>
        <p><strong>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è:</strong> ${order.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-ready">–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ</span></p>
      `;
      info.style.display = "block";
      document.getElementById("action-buttons").style.display = "block";
      hideLoading();
      logAction("ORDER_LOADED", { orderId });
    }).catch(err => {
      handleError(err, "loadOrder");
      hideLoading();
    });
  }

  // === –í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞ ===
  function confirmIssue() {
    if (!currentOrderKey) {
      alert("–ù–µ –≤—ã–±—Ä–∞–Ω –∑–∞–∫–∞–∑!");
      return;
    }

    showLoading("–í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞...");

    db.ref('orders/' + currentOrderKey).update({
      status: "issued",
      issuedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      // –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if ('speechSynthesis' in window) {
        const msg = `–ó–∞–∫–∞–∑ –≤—ã–¥–∞–Ω. –û–ø–ª–∞—Ç–∞ ${currentOrderKey}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–≤–∞—Ä –ø–æ–¥ –∫–∞–º–µ—Ä–∞–º–∏.`;
        const utterance = new SpeechSynthesisUtterance(msg);
        utterance.lang = 'ru-RU';
        speechSynthesis.speak(utterance);
      }
      alert("‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω!");
      resetUI();
      logAction("ISSUED", { orderId: currentOrderKey });
    }).catch(err => {
      handleError(err, "confirmIssue");
      hideLoading();
    });
  }

  // === –ü–æ–º–µ—Ç–∫–∞ –±—Ä–∞–∫–∞ ===
  function markAsDefect() {
    if (!currentOrderKey) {
      alert("–ù–µ –≤—ã–±—Ä–∞–Ω –∑–∞–∫–∞–∑!");
      return;
    }

    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ç–æ–≤–∞—Ä –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–π?")) return;

    showLoading("–ü–æ–º–µ—Ç–∫–∞ –±—Ä–∞–∫–∞...");

    db.ref('orders/' + currentOrderKey).update({
      status: "defect",
      defectAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      alert("‚ö†Ô∏è –¢–æ–≤–∞—Ä –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –±—Ä–∞–∫!");
      resetUI();
      logAction("DEFECT", { orderId: currentOrderKey });
    }).catch(err => {
      handleError(err, "markAsDefect");
      hideLoading();
    });
  }

  // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
  function showLoading(message = "–ó–∞–≥—Ä—É–∑–∫–∞...") {
    document.getElementById("order-info").innerHTML = `<p>${message}</p>`;
    document.getElementById("order-info").style.display = "block";
  }

  function hideLoading() {
    // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  }

  // === –í–∞–ª–∏–¥–∞—Ü–∏—è ===
  function validateOrderId(id) {
    return typeof id === 'string' && id.length >= 20;
  }

  function validateOrderData(order) {
    return order && order.userId && order.items && order.total;
  }

  // === –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ===
  function formatPhoneNumber(phone) {
    return phone.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/, '+$1 ($2) $3-$4-$5');
  }

  function getPaymentLabel(method) {
    return method === 'cash' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–û–Ω–ª–∞–π–Ω';
  }

  // === –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ===
  function logAction(action, data) {
    console.log(`[PVZ] ${action}`, data, new Date().toISOString());
  }

  // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ===
  function handleError(error, context) {
    console.error(`[PVZ ERROR in ${context}]:`, error);
    alert(`–û—à–∏–±–∫–∞: ${error.message || error}`);
  }

  // === –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
  function runTests() {
    console.log("–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ü–í–ó...");
    console.assert(validateOrderId("abc123") === false, "–¢–µ—Å—Ç ID 1");
    console.assert(validateOrderId("longer_than_20_characters_id") === true, "–¢–µ—Å—Ç ID 2");
    console.log("–¢–µ—Å—Ç—ã –ü–í–ó –∑–∞–≤–µ—Ä—à–µ–Ω—ã.");
  }

  // === –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ===
  window.onload = () => {
    document.getElementById("login-screen").style.display = "flex";
    // runTests(); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  };

  // === –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã ===
  function getTimestamp() {
    return firebase.database.ServerValue.TIMESTAMP;
  }

  function sanitizeInput(input) {
    return DOMPurify ? DOMPurify.sanitize(input) : input;
  }

  // === –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ===
  if (!window.speechSynthesis) {
    console.warn("SpeechSynthesis –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ");
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  console.log("–°–∏—Å—Ç–µ–º–∞ –ü–í–ó –≤–µ—Ä—Å–∏–∏ 2.0 –∑–∞–ø—É—â–µ–Ω–∞.");
</script>

</body>
</html>
