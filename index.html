<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wildberries ‚Äî –ü–í–ó</title>
  <!-- 
    –§–∞–π–ª: pvz/index.html
    –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–∞–π—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ü–í–ó
    –ê–≤—Ç–æ—Ä: –°–∏—Å—Ç–µ–º–∞ Wildberries Clone
    –í–µ—Ä—Å–∏—è: 5.0
    –î–∞—Ç–∞: 2025-04-05
    –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
      - –í—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é 0506
      - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–∫–∏ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 4 —Ü–∏—Ñ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞
      - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∫–ª–µ–π–∫–∏ —Å —Ç–æ–≤–∞—Ä–∞ (13 —Ü–∏—Ñ—Ä)
      - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 4 —Ü–∏—Ñ—Ä
      - –ö–Ω–æ–ø–∫–∏ "–í—ã–¥–∞—Ç—å" –∏ "–ë—Ä–∞–∫" –∞–∫—Ç–∏–≤–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
      - –û—à–∏–±–∫–∞ "–ù–µ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥–∞" –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏
      - –†–∞–±–æ—Ç–∞ —Å Firebase
      - –ú–∏–Ω–∏–º—É–º 560 —Å—Ç—Ä–æ–∫, –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª–µ–Ω–æ
  -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #f0f0ff 0%, #e0e0ff 100%); color: #333; min-height: 100vh; }
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
    #login-screen { display: flex; background: linear-gradient(135deg, #6c5ce7 0%, #5d4de0 100%); color: white; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
    .logo { font-size: 36px; font-weight: bold; margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input, button { padding: 14px; margin: 10px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; width: 100%; max-width: 400px; }
    input { background: white; color: #333; }
    button { cursor: pointer; background: #6c5ce7; color: white; border: none; font-weight: bold; }
    button:hover { background: #5d4de0; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-danger { background: #e74c3c; }
    .btn-success { background: #2ecc71; }
    .btn-warning { background: #f39c12; }
    .order-card { background: white; border-radius: 12px; padding: 18px; margin: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
    .header h2 { color: #6c5ce7; }
    .scan-area { background: white; padding: 25px; border-radius: 12px; text-align: center; margin: 20px 0; box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .scan-input { width: 100%; padding: 14px; font-size: 18px; text-align: center; border: 2px solid #6c5ce7; border-radius: 8px; }
    .order-info { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .actions { margin: 20px 0; }
    .status-ready { color: #2ecc71; font-weight: bold; }
    .status-defect { color: #e74c3c; font-weight: bold; }
    .item-preview { display: flex; align-items: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    .item-image { width: 80px; height: 80px; object-fit: cover; margin-right: 15px; border: 1px solid #ddd; }
    .item-details { flex: 1; }
    .qr-container { background: white; padding: 20px; border-radius: 12px; text-align: center; margin: 20px auto; max-width: 300px; box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .qr-header { color: #6c5ce7; font-size: 24px; font-weight: bold; margin-bottom: 10px; }
    .qr-barcode { margin: 15px 0; font-family: monospace; font-size: 16px; }
    .qr-numbers { font-family: monospace; font-size: 18px; margin-top: 5px; }
    .footer { text-align: center; margin-top: auto; padding: 20px; color: #666; font-size: 14px; }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="login-screen" class="screen">
  <div class="logo">–ü–í–ó Wildberries</div>
  <h2>–í—Ö–æ–¥ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>
  <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∫–∞—Å—Å–∏—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ</p>
  <input type="password" id="password-input" placeholder="–ü–∞—Ä–æ–ª—å: 0506" maxlength="4" autofocus />
  <button onclick="login()">–í–æ–π—Ç–∏</button>
  <div class="footer">
    <p>¬© 2025 Wildberries Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="main-screen" class="screen">
  <div class="header">
    <h2>üì¶ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ ‚Äî –ë–∞–ª–∞—à–∏—Ö–∞</h2>
    <div>
      <button onclick="showNewOrders()">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</button>
      <button onclick="showReviews()">–û—Ç–∑—ã–≤—ã</button>
      <button onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
  </div>
  <div class="scan-area">
    <h3>üîç –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</p>
    <input type="text" class="scan-input" id="client-scan-input" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞..." oninput="handleClientScan()" autocomplete="off" />
  </div>
  <!-- –ü–æ–ª–µ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∫–ª–µ–π–∫–∏ —Å —Ç–æ–≤–∞—Ä–∞ -->
  <div class="scan-area" id="label-scan-area" style="display:none; margin-top:20px;">
    <h3>üì¶ –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –Ω–∞–∫–ª–µ–π–∫—É —Å —Ç–æ–≤–∞—Ä–∞</h3>
    <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ 13-–∑–Ω–∞—á–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥ —Å —É–ø–∞–∫–æ–≤–∫–∏</p>
    <input type="text" class="scan-input" id="label-scan-input" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥..." oninput="handleLabelScan()" autocomplete="off" maxlength="13" />
  </div>
  <div id="order-info" class="order-info" style="display:none;"></div>
  <div class="actions" id="action-buttons" style="display:none;">
    <button class="btn-success" onclick="confirmIssue()">–í—ã–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
    <button class="btn-danger" onclick="markAsDefect()">–ë—Ä–∞–∫</button>
  </div>
  <div class="footer">
    <p>¬© 2025 Wildberries Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<!-- –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã -->
<div id="new-orders-screen" class="screen">
  <div class="header">
    <h2>üÜï –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</h2>
    <button onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
  <div id="new-orders-list"></div>
  <div class="footer">
    <p>¬© 2025 Wildberries Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏—ë–º–∞ –∑–∞–∫–∞–∑–∞ -->
<div id="receive-screen" class="screen">
  <div class="header">
    <h2>üñ®Ô∏è –ü—Ä–∏—ë–º –∑–∞–∫–∞–∑–∞</h2>
    <button onclick="backToNewOrders()">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
  <div id="order-details"></div>
  <div class="qr-container" id="qr-container" style="display:none;">
    <div class="qr-header">WB</div>
    <div id="qr-code"></div>
    <svg id="barcode-svg" style="width:100%; height:60px; margin:10px 0;"></svg>
    <div class="qr-numbers" id="barcode-number"></div>
  </div>
  <input type="text" class="location-input" id="location-input" placeholder="–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–ª–∫–∞ 12)" style="width:100%; padding:12px; margin:10px 0;" />
  <button class="btn-success" onclick="confirmReceive()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏—ë–º</button>
  <button class="btn-warning" onclick="markAsDefect()">–ë—Ä–∞–∫</button>
  <div class="footer">
    <p>¬© 2025 Wildberries Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<!-- –û—Ç–∑—ã–≤—ã -->
<div id="reviews-screen" class="screen">
  <div class="header">
    <h2>‚≠ê –û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
    <button onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
  <div id="reviews-list"></div>
  <div class="footer">
    <p>¬© 2025 Wildberries Clone. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<script>
  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ===
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
  const CASHIER_PASSWORD = "0506";
  let currentOrderKey = null;
  let currentOrder = null;
  let clientOrderId = null;
  let expectedLast4 = null; // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –∏–∑ –∑–∞–∫–∞–∑–∞

  // === –í—Ö–æ–¥ ===
  function login() {
    if (document.getElementById("password-input").value === CASHIER_PASSWORD) {
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("main-screen").style.display = "flex";
      document.getElementById("client-scan-input").focus();
    } else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    }
  }

  function logout() {
    currentOrderKey = null;
    clientOrderId = null;
    expectedLast4 = null;
    document.getElementById("main-screen").style.display = "none";
    document.getElementById("new-orders-screen").style.display = "none";
    document.getElementById("receive-screen").style.display = "none";
    document.getElementById("reviews-screen").style.display = "none";
    document.getElementById("login-screen").style.display = "flex";
    document.getElementById("password-input").value = "";
    resetUI();
  }

  function resetUI() {
    document.getElementById("order-info").style.display = "none";
    document.getElementById("action-buttons").style.display = "none";
    document.getElementById("client-scan-input").value = "";
    document.getElementById("label-scan-input").value = "";
    document.getElementById("label-scan-area").style.display = "none";
    clientOrderId = null;
    expectedLast4 = null;
  }

  function backToMain() {
    document.getElementById("new-orders-screen").style.display = "none";
    document.getElementById("receive-screen").style.display = "none";
    document.getElementById("reviews-screen").style.display = "none";
    document.getElementById("main-screen").style.display = "flex";
  }

  function backToNewOrders() {
    document.getElementById("receive-screen").style.display = "none";
    document.getElementById("new-orders-screen").style.display = "flex";
    loadNewOrders();
  }

  // === –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã ===
  function showNewOrders() {
    document.getElementById("main-screen").style.display = "none";
    document.getElementById("new-orders-screen").style.display = "flex";
    loadNewOrders();
  }

  function loadNewOrders() {
    const list = document.getElementById("new-orders-list");
    list.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤...</p>";

    db.ref('orders')
      .orderByChild('status')
      .equalTo('created')
      .once('value')
      .then(snapshot => {
        list.innerHTML = "";
        if (!snapshot.exists()) {
          list.innerHTML = "<p>–ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.</p>";
          return;
        }

        snapshot.forEach(child => {
          const order = child.val();
          const div = document.createElement("div");
          div.className = "order-card";
          div.innerHTML = `
            <h3>–ó–∞–∫–∞–∑ ‚Ññ${child.key.slice(-6)}</h3>
            <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.userId}</p>
            <p><strong>–°—É–º–º–∞:</strong> ${order.total} ‚ÇΩ</p>
            <p><strong>–û–ø–ª–∞—Ç–∞:</strong> ${order.paymentMethod === 'cash' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–û–Ω–ª–∞–π–Ω'}</p>
            <p><strong>–¢–æ–≤–∞—Ä–æ–≤:</strong> ${order.items.length}</p>
            <button class="btn-success" onclick="prepareReceive('${child.key}')">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
          `;
          list.appendChild(div);
        });
      });
  }

  // === –ü—Ä–∏—ë–º –∑–∞–∫–∞–∑–∞ ===
  function prepareReceive(orderKey) {
    db.ref('orders/' + orderKey).once('value').then(snapshot => {
      const order = snapshot.val();
      if (!order) {
        alert("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
        return;
      }

      currentOrderKey = orderKey;
      currentOrder = order;
      document.getElementById("new-orders-screen").style.display = "none";
      document.getElementById("receive-screen").style.display = "flex";

      document.getElementById("order-details").innerHTML = `
        <h3>–ó–∞–∫–∞–∑ ‚Ññ${orderKey.slice(-6)}</h3>
        <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.userId}</p>
        <p><strong>–°—É–º–º–∞:</strong> ${order.total} ‚ÇΩ</p>
        <p><strong>–û–ø–ª–∞—Ç–∞:</strong> ${order.paymentMethod === 'cash' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–û–Ω–ª–∞–π–Ω'}</p>
        <h4>–¢–æ–≤–∞—Ä—ã:</h4>
        <div id="item-previews">${order.items.map(item => `
          <div class="item-preview">
            <img class="item-image" src="https://via.placeholder.com/80?text=–¢–æ–≤–∞—Ä" alt="${item.name}" />
            <div class="item-details">
              <strong>${item.name}</strong><br>
              ${item.price} ‚ÇΩ
            </div>
          </div>
        `).join('')}</div>
      `;

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –Ω–∞ —Ç–æ–≤–∞—Ä
      const qrData = JSON.stringify({
        orderId: orderKey,
        pvz: "PVZ_BALASHIHA_32D",
        timestamp: Date.now()
      });

      document.getElementById("qr-code").innerHTML = "";
      new QRCode(document.getElementById("qr-code"), {
        text: qrData,
        width: 180,
        height: 180
      });

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ (EAN-13)
      const now = Date.now().toString().slice(-9);
      const nameHash = order.items[0].name.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0).toString().replace('-', '').slice(0,3);
      let code12 = (now + nameHash).padEnd(12, '0').slice(0,12);
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(code12[i]) * (i % 2 === 0 ? 1 : 3);
      }
      const check = (10 - (sum % 10)) % 10;
      const barcode = code12 + check;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –≤ –∑–∞–∫–∞–∑–µ
      db.ref('orders/' + orderKey).update({ last4: barcode.slice(-4) });

      JsBarcode("#barcode-svg", barcode, {
        format: "EAN13",
        lineColor: "#000",
        height: 50,
        fontSize: 16,
        displayValue: true,
        textAlign: "center"
      });
      document.getElementById("barcode-number").textContent = barcode;
      document.getElementById("qr-container").style.display = "block";
    }).catch(err => {
      alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞: " + err.message);
    });
  }

  function confirmReceive() {
    const location = document.getElementById("location-input").value.trim();
    if (!location) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è!");
      return;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ last4
    const now = Date.now().toString().slice(-9);
    const nameHash = currentOrder.items[0].name.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0).toString().replace('-', '').slice(0,3);
    let code12 = (now + nameHash).padEnd(12, '0').slice(0,12);
    let sum = 0;
    for (let i = 0; i < 12; i++) sum += parseInt(code12[i]) * (i % 2 === 0 ? 1 : 3);
    const check = (10 - (sum % 10)) % 10;
    const barcode = code12 + check;
    const last4 = barcode.slice(-4);

    db.ref('orders/' + currentOrderKey).update({
      status: "received",
      location: location,
      last4: last4,
      receivedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      if ('speechSynthesis' in window) {
        const msg = `–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤. –ü–æ–ª–∫–∞: ${location}. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã: ${last4}.`;
        const utterance = new SpeechSynthesisUtterance(msg);
        utterance.lang = 'ru-RU';
        speechSynthesis.speak(utterance);
      }
      alert("–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!");
      document.getElementById("receive-screen").style.display = "none";
      showNewOrders();
    });
  }

  // === –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–ª–∏–µ–Ω—Ç–∞ ===
  function handleClientScan() {
    const input = document.getElementById("client-scan-input");
    let value = input.value.trim();
    if (value.length < 10) return;

    try {
      const data = JSON.parse(value);
      if (data.orderId) {
        loadOrderForIssue(data.orderId);
        input.value = "";
      }
    } catch (e) {
      if (/^[A-Za-z0-9_-]{20,}$/.test(value)) {
        loadOrderForIssue(value);
        input.value = "";
      }
    }
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ ===
  function loadOrderForIssue(orderId) {
    document.getElementById("order-info").innerHTML = "<p>–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞...</p>";
    document.getElementById("order-info").style.display = "block";

    db.ref('orders/' + orderId).once('value').then(snapshot => {
      const order = snapshot.val();
      if (!order || order.status !== 'received') {
        document.getElementById("order-info").innerHTML = "<p style='color:red;'>‚ùå –ó–∞–∫–∞–∑ –Ω–µ –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ!</p>";
        setTimeout(resetUI, 3000);
        return;
      }

      clientOrderId = orderId;
      expectedLast4 = order.last4 || '0000'; // –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω

      document.getElementById("order-info").innerHTML = `
        <h3>–ó–∞–∫–∞–∑ ‚Ññ${orderId.slice(-6)}</h3>
        <div class="item-preview">
          <img class="item-image" src="https://via.placeholder.com/80?text=–¢–æ–≤–∞—Ä" alt="${order.items[0].name}" />
          <div class="item-details">
            <strong>${order.items[0].name}</strong><br>
            ${order.total} ‚ÇΩ
          </div>
        </div>
        <p><strong>–ü–æ–ª–∫–∞:</strong> ${order.location || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
        <p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã:</strong> ${expectedLast4}</p>
        <p><strong>–û–ø–ª–∞—Ç–∞:</strong> ${order.paymentMethod === 'cash' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–û–Ω–ª–∞–π–Ω'}</p>
      `;
      document.getElementById("order-info").style.display = "block";
      document.getElementById("label-scan-area").style.display = "block";
      document.getElementById("label-scan-input").focus();
    });
  }

  // === –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∫–ª–µ–π–∫–∏ —Å —Ç–æ–≤–∞—Ä–∞ ===
  function handleLabelScan() {
    const input = document.getElementById("label-scan-input");
    let barcode = input.value.trim();

    if (barcode.length !== 13) return;

    const last4 = barcode.slice(-4);
    if (last4 === expectedLast4) {
      document.getElementById("action-buttons").style.display = "block";
      alert("‚úÖ –®—Ç—Ä–∏—Ö–∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!");
    } else {
      alert("‚ùå –ù–µ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥–∞");
      input.value = "";
    }
  }

  // === –í—ã–¥–∞—á–∞ –∏ –±—Ä–∞–∫ ===
  function confirmIssue() {
    if (!clientOrderId) {
      alert("–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–ª–∏–µ–Ω—Ç–∞ –∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞!");
      return;
    }
    db.ref('orders/' + clientOrderId).update({ status: "issued" }).then(() => {
      alert("‚úÖ –¢–æ–≤–∞—Ä –≤—ã–¥–∞–Ω!");
      resetUI();
    });
  }

  function markAsDefect() {
    if (!clientOrderId) {
      alert("–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–ª–∏–µ–Ω—Ç–∞ –∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞!");
      return;
    }
    if (!confirm("–ë—Ä–∞–∫?")) return;
    db.ref('orders/' + clientOrderId).update({ status: "defect" }).then(() => {
      alert("‚ö†Ô∏è –ë—Ä–∞–∫!");
      resetUI();
    });
  }

  // === –û—Ç–∑—ã–≤—ã ===
  function showReviews() {
    document.getElementById("main-screen").style.display = "none";
    document.getElementById("reviews-screen").style.display = "flex";
    loadReviews();
  }

  function loadReviews() {
    const list = document.getElementById("reviews-list");
    list.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</p>";
    db.ref('orders').orderByChild('status').equalTo('issued').limitToLast(10).once('value').then(snapshot => {
      list.innerHTML = "";
      if (!snapshot.exists()) {
        list.innerHTML = "<p>–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>";
        return;
      }
      let count = 0;
      snapshot.forEach(child => {
        if (count >= 5) return;
        const order = child.val();
        const div = document.createElement("div");
        div.className = "order-card";
        const rating = Math.floor(Math.random() * 2) + 4;
        const comment = ["–û—Ç–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å!", "–ë—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ!", "–°–ø–∞—Å–∏–±–æ!", "–í—Å—ë –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å!", "–†–µ–∫–æ–º–µ–Ω–¥—É—é!"][Math.floor(Math.random() * 5)];
        div.innerHTML = `
          <div style="color:#f39c12; font-size:20px;">{"‚òÖ".repeat(rating)}{"‚òÜ".repeat(5 - rating)}</div>
          <p>${comment}</p>
          <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.userId}</p>
        `;
        list.appendChild(div);
        count++;
      });
    });
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  document.getElementById("login-screen").style.display = "flex";
</script>

</body>
</html>
